.. image:: ./doc/001samune.png

=====================================================================
【初心者向け】Amazon Cognito について整理する
=====================================================================
* `詳細 <>`_

=====================================================================
構成図
=====================================================================

ID pool
=====================================================================
.. image:: ./doc/drawio/architecture_id_pool.drawio.png

User pool
=====================================================================
.. image:: ./doc/drawio/architecture_user_pool.drawio.png

=====================================================================
デプロイ - CloudFormation -
=====================================================================

作業環境 - ローカル -
=====================================================================
* macOS Sequoia ( v15.7.2 )
* Visual Studio Code 1.106.3
* Rain v1.24.2
* aws-cli 2.33.12

フォルダ構成
=====================================================================
* `こちら <./folder.md>`_ を参照

前提条件
=====================================================================
* *AdministratorAccess* がアタッチされているIAMユーザーを作成していること
* 実作業は *envs* フォルダ配下の各環境フォルダで実施すること
* 以下コマンドを実行し、*admin* プロファイルを作成していること (デフォルトリージョンは *ap-northeast-1* )

.. code-block:: bash

  aws login --profile admin

事前作業(1)
=====================================================================
1. 各種モジュールインストール
---------------------------------------------------------------------
* `GitHub <https://github.com/tyskJ/common-environment-setup>`_ を参照

事前作業(2)
=====================================================================
1. デプロイ用バケット作成
---------------------------------------------------------------------
.. code-block:: bash

  aws s3 mb \
  s3://cfn-working \
  --profile admin 

.. note::

  * バケット名は、全世界で一意である必要があります
  * 作成に失敗した場合は、バケット名を修正してください


実作業 - ローカル -
=====================================================================
.. note::

  * 試したい方をデプロイしてください

ID pool 検証用スタックデプロイ
---------------------------------------------------------------------
* 変数ファイル作成

.. code-block:: bash

  cat <<EOF > config/id-pool-parameter.yml
  Parameters:
    AuthUserEmail: "認証ユーザー用メールアドレス"
  EOF

* デプロイ

.. code-block:: bash

  rain deploy id-pool.yml ID-POOL \
  --s3-bucket cfn-working \
  --config config/id-pool-parameter.yml \
  --profile admin -y

.. note::

  * S3バケット名は必要に応じて修正してください

User pool 検証用スタックデプロイ
---------------------------------------------------------------------
* 変数ファイル作成

.. code-block:: bash

  cat <<EOF > config/user-pool-parameter.yml
  Parameters:
    HostedZoneId: "パブリックホストゾーンID"
    DomainName: "API Gatwayカスタムドメイン名"
  EOF

* デプロイ

.. code-block:: bash

  rain deploy user-pool.yml USER-POOL \
  --s3-bucket cfn-working \
  --config config/user-pool-parameter.yml \
  --profile admin

.. note::

  * S3バケット名は必要に応じて修正してください

後片付け - ローカル -
=====================================================================
1. 検証用スタック削除
---------------------------------------------------------------------
.. code-block:: bash

  rain rm ID-POOL --profile admin -y
  rain rm USER-POOL --profile admin -y

.. note::

  * 試した方を削除してください

2. デプロイ用バケット削除
---------------------------------------------------------------------
.. code-block:: bash

  aws s3 rm --recursive s3://cfn-working --profile admin
  aws s3 rb s3://cfn-working --profile admin

.. note::

  * S3バケット名は必要に応じて修正してください
